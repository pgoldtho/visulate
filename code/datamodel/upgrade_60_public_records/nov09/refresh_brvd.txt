Upgrade notes for Brevard Property Appraiser

Create database link to connect to the mdb file

execute C:\Windows\SysWOW64\odbcad32.exe
Create a System DSN called BREV1

Edit listener.ora to add an hsodbc entry

SID_LIST_LISTENER =
  (SID_LIST =
    (SID_DESC =
      (SID_NAME = PLSExtProc)
      (ORACLE_HOME = C:\oraclexe\app\oracle\product\10.2.0\server)
      (PROGRAM = extproc)
    )
    (SID_DESC =
      (SID_NAME = CLRExtProc)
      (ORACLE_HOME = C:\oraclexe\app\oracle\product\10.2.0\server)
      (PROGRAM = extproc)
    )
    (SID_DESC =
      (SID_NAME = hsodbc)
      (ORACLE_HOME = C:\oraclexe\app\oracle\product\10.2.0\server)
      (PROGRAM = hsodbc)
    )

  )

LISTENER =
  (DESCRIPTION_LIST =
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC_FOR_XE))
      (ADDRESS = (PROTOCOL = TCP)(HOST = pgoldtho-quad)(PORT = 1521))
    )
  )

DEFAULT_SERVICE_LISTENER = (XE)

Bounce the listener

lsnrctl stop
lsnrctl start

Edit C:\oraclexe\app\oracle\product\10.2.0\server\hs\admin\inithsodbc.ora
Add an entry for the ODBC System DSN (BREV1)

HS_FDS_CONNECT_INFO = BREV1
HS_FDS_TRACE_LEVEL = off

Edit tnsnames.ora add

access_db =
  (DESCRIPTION =
     (ADDRESS = (PROTOCOL = TCP)(HOST = pgoldtho-quad) (PORT = 1521)
  )
  (CONNECT_DATA =
      (SID = hsodbc)
  )
  (HS=OK)
 )

sqlplus system/manager

create public database link brvd using 'access_db';



Data is delivered in an Access database file called web97.mdb.  This should be staged in e:\work\brevard on pgoldtho-pc4 a database link has been setup to connect to this location.
Materialized views have been created to pull data from the Access tables.  These need to be refreshed.

begin
  DBMS_MVIEW.REFRESH('pr_brvd_properties_mv');
  DBMS_MVIEW.REFRESH('pr_brvd_taxes_mv');
  DBMS_MVIEW.REFRESH('pr_brvd_building_mv'); 
  DBMS_MVIEW.REFRESH('pr_brvd_sales_mv');
end;
/ 

Drop and recreate the following tables

drop table brd_properties purge;
drop table brd_buildings purge;
drop table brd_sales purge;



-- New Properties Since Last Run
create table brd_properties as 
 select  *
 from pr_brvd_properties_mv
 where not exists (select 1 
                   from pr_properties 
                   where address1 =  rtrim("SiteHouseNo"||' '||"SiteStreetname"||' '||"SiteType"||' '||"SiteDir"))
 and "SiteStreetname" is not null

-- Buildings for new properties
create table brd_buildings as 
 select  *
 from pr_brvd_building_mv
 where "TaxAcct" in (select "TaxAcct" from brd_properties);


create index pr_properties_fn on pr_properties(to_number(source_pk));


-- Sales history 
*************************************************************************************
**** modify SaleDate condition ****
**** move pr_records_pkg.get_prop_id(to_char(s."TaxAcct")) to brevard10.sql *****
************************************************************************************
create table brd_sales as 
select s."TaxAcct"
,      "BookPg"
,      "SaleDate"
,      "SaleAmount"
,      "DeedType"
,      "DeedQual"
,      "SaleConfirm"
,      "VorI"
,      "PriorOwner"
,      "DateAdded"
,      "PhysChangeCode"
,      "SalesId"
,      pr_records_pkg.get_prop_id(to_char(s."TaxAcct")) prop_id
,      "OwnerName"
from pr_brvd_sales_mv s
,    pr_brvd_properties_mv p
where (to_char("SaleDate", 'yyyy') = 2009 or
       to_char("SaleDate", 'yyyy') = 2010)  
and p."TaxAcct" = s."TaxAcct";


create table brd_sales_properties as
  select p."TaxAcct"          source_pk
  ,      "OwnerName"        owner_name
  ,      rtrim("SiteHouseNo"||' '||"SiteStreetname"||' '||"SiteType"||' '||"SiteDir") address1
  ,      "SiteAptNo"        address2
  ,      "SiteCity"         city
  ,      "SiteZip5"         zipcode
  ,      "BuildingSqFt"     sq_ft
  ,      "Acreage"          acreage
  ,      "MailHouseNo"||' '||"MailAddressLine1" mail_address1
  ,      "MailAddressLine2" mail_address2
  ,      "MailCity"         mail_city
  ,      "MailState"        mail_state
  ,      "MailZip5"         mail_zipcode
  from pr_brvd_sales_mv s
  ,    pr_brvd_properties_mv p
where (to_char("SaleDate", 'yyyy') = 2009 or
       to_char("SaleDate", 'yyyy') = 2010)  
and p."TaxAcct" = s."TaxAcct";



export the tables and import into the target database

BRD_BUILDINGS
BRD_PROPERTIES
BRD_SALES

Verfiy the following sequences exist:

create sequence  PR_SOURCES_SEQ     start with 4;
create sequence  PR_PROPERTIES_SEQ  start with 472040;
create sequence  PR_OWNERS_SEQ      start with 865011;
create sequence  PR_BUILDINGS_SEQ   start with 423624;

and the following index:

alter table pr_property_sales drop constraint pr_property_sales_pk;
drop index pr_property_sales_pk;

alter table pr_property_sales add constraint pr_property_sales_pk
unique(prop_id, new_owner_id, sale_date);

@pr_records_pkg


@brevard2.sql
@brevard5.sql
@brevard8.sql
@brevard10.sql



begin
  DBMS_MVIEW.REFRESH('PR_COMMERCIAL_SALES_MV', 'C');
  DBMS_MVIEW.REFRESH('PR_COMMERCIAL_SUMMARY_MV', 'C'); 
  DBMS_MVIEW.REFRESH('PR_SALES_MV', 'C'); 
  DBMS_MVIEW.REFRESH('PR_SALES_SUMMARY_MV', 'C'); 
end;
/


	